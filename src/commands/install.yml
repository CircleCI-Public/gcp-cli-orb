description: |
  Install the gcloud CLI, if not available

parameters:
  use-latest:
    type: boolean
    default: true
    description: >
      Install the latest version of the CLI? If false, specify a version
      below

  sdk-version:
    type: string
    default: ""
    description: >
      Pick a version of the gcloud CLI to install:
      https://cloud.google.com/sdk/docs/downloads-versioned-archives
      https://console.cloud.google.com/storage/browser/cloud-sdk-release

  install-dir:
    type: string
    default: $HOME
    description: >
      Where should the gcloud CLI be installed?

steps:
  - when:
      condition: <<parameters.use-latest>>
      steps:
        - run:
            name: Install latest gcloud CLI version, if not available
            command: |
              if [[ $(command -v gcloud) == "" ]]; then
                curl https://sdk.cloud.google.com > gcloud-install.sh

                bash install.sh --disable-prompts --install-dir=<<parameters.install-dir>>

                export PATH="<<parameters.install-dir>>/google-cloud-sdk/bin:$PATH"
              else
                echo "gcloud CLI is already installed."
              fi

  - unless:
      condition: <<parameters.use-latest>>
      steps:
        - run:
            name: Install gcloud CLI v<<parameters.sdk-version>>, if not available
            command: |
              if [[ $(command -v gcloud) == "" ]]; then
                curl https://storage.cloud.google.com/cloud-sdk-release/google-cloud-sdk-<<parameters.sdk-version>>-linux-x86_64.tar.gz > gcloud-install.tar.gz

                tar -xvf gcloud-install.tar.gz --disable-prompts --install-dir=<<parameters.install-dir>>

                export PATH="<<parameters.install-dir>>/google-cloud-sdk/bin:$PATH"
              else
                echo "gcloud CLI is already installed."
              fi

  - run:
      name: Run gcloud init, verify version
      command: |
        gcloud init
        gcloud version
